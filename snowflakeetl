import pandas as pd
import os
from datetime import datetime
import snowflake.connector
from snowflake.connector.pandas_tools import write_pandas
from dotenv import load_dotenv


# Load Environment Variables

load_dotenv()

pd.set_option('display.max_columns', None)
load_timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

# Load Source Files

csv_df = pd.read_csv("source_data.csv")
excel_df = pd.read_excel("source_data.xlsx")

csv_df.columns = csv_df.columns.str.strip().str.upper()
excel_df.columns = excel_df.columns.str.strip().str.upper()


# PART1  - RAW LAYER

raw_df = pd.concat([csv_df, excel_df], ignore_index=True)

def standardize_gender(g):
    if pd.isna(g):
        return 'O'
    g = str(g).strip().lower()
    if g in ['male','m']:
        return 'M'
    elif g in ['female','f']:
        return 'F'
    else:
        return 'O'

raw_df['GENDER'] = raw_df['GENDER'].apply(standardize_gender)

# DOB Conversion
raw_df['DOB'] = pd.to_datetime(raw_df['DOB'], errors='coerce')

today = pd.Timestamp.today()

# Age Calculation
raw_df['AGE'] = today.year - raw_df['DOB'].dt.year
raw_df['AGE'] = raw_df['AGE'] - (
    (today.month < raw_df['DOB'].dt.month) |
    ((today.month == raw_df['DOB'].dt.month) &
     (today.day < raw_df['DOB'].dt.day))
)

raw_df['DOB'] = raw_df['DOB'].dt.strftime('%d-%m-%Y')
raw_df['LOAD_TIMESTAMP'] = load_timestamp

# FINAL LAYER
raw_df = raw_df.reset_index(drop=True)


# PART2 - FINAL LAYER

joined_df = pd.merge(
    csv_df,
    excel_df,
    on="USER_ID",
    how="inner",
    suffixes=('_CSV', '_EXCEL')
)

# Gender selection
joined_df['GENDER'] = joined_df['GENDER_CSV'].combine_first(joined_df['GENDER_EXCEL'])
joined_df['GENDER'] = joined_df['GENDER'].apply(standardize_gender)

# DOB selection
joined_df['DOB'] = joined_df['DOB_CSV'].combine_first(joined_df['DOB_EXCEL'])
joined_df['DOB'] = pd.to_datetime(joined_df['DOB'], errors='coerce')

# Age calculation
joined_df['AGE'] = today.year - joined_df['DOB'].dt.year
joined_df['AGE'] = joined_df['AGE'] - (
    (today.month < joined_df['DOB'].dt.month) |
    ((today.month == joined_df['DOB'].dt.month) &
     (today.day < joined_df['DOB'].dt.day))
)

final_df = joined_df[joined_df['AGE'] > 18].copy()

# Safe NAME Selection
if 'NAME_CSV' in final_df.columns:
    final_df['NAME'] = final_df['NAME_CSV']
elif 'NAME' not in final_df.columns and 'NAME_EXCEL' in final_df.columns:
    final_df['NAME'] = final_df['NAME_EXCEL']

# Format DOB
final_df['DOB'] = final_df['DOB'].dt.strftime('%d-%m-%Y')

# Audit Column
final_df['LOAD_TIMESTAMP'] = load_timestamp

# Keep Only Required Columns
final_df = final_df[
    [
        'USER_ID',
        'NAME',
        'EMAIL',
        'GENDER',
        'DOB',
        'AGE',
        'LOAD_TIMESTAMP'
    ]
]

final_df = final_df.reset_index(drop=True)


# PART3 - SNOWFLAKE LOADING

conn = snowflake.connector.connect(
    user=os.getenv("SNOWFLAKE_USER"),
    password=os.getenv("SNOWFLAKE_PASSWORD"),
    account=os.getenv("SNOWFLAKE_ACCOUNT"),
    warehouse=os.getenv("SNOWFLAKE_WAREHOUSE"),
    database=os.getenv("SNOWFLAKE_DATABASE"),
    schema=os.getenv("SNOWFLAKE_SCHEMA")
)

cursor = conn.cursor()

cursor.execute(f"USE WAREHOUSE {os.getenv('SNOWFLAKE_WAREHOUSE')}")

# Create RAW table
cursor.execute("""
CREATE OR REPLACE TABLE RAW_USER_DATA (
    USER_ID NUMBER,
    NAME STRING,
    GENDER STRING,
    DOB STRING,
    CITY STRING,
    EMAIL STRING,
    COUNTRY STRING,
    AGE NUMBER,
    LOAD_TIMESTAMP TIMESTAMP
)
""")

# Create FINAL table
cursor.execute("""
CREATE OR REPLACE TABLE FINAL_USER_DATA (
    USER_ID NUMBER,
    NAME STRING,
    EMAIL STRING,
    GENDER STRING,
    DOB STRING,
    AGE NUMBER,
    LOAD_TIMESTAMP TIMESTAMP
)
""")

# Load RAW
success, nchunks, nrows, _ = write_pandas(
    conn,
    raw_df,
    "RAW_USER_DATA"
)
print(f"RAW_USER_DATA Loaded: {nrows} rows")

# Load FINAL
success, nchunks, nrows, _ = write_pandas(
    conn,
    final_df,
    "FINAL_USER_DATA"
)
print(f"FINAL_USER_DATA Loaded: {nrows} rows")

cursor.close()
conn.close()