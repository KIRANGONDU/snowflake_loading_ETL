import pandas as pd
import os
from dotenv import load_dotenv
import snowflake.connector
from snowflake.connector.pandas_tools import write_pandas

load_dotenv()

pd.set_option('display.max_columns', None)
 

csv_df = pd.read_csv("source_data.csv")
excel_df = pd.read_excel("source_data.xlsx")

csv_df.columns = csv_df.columns.str.strip().str.upper()
excel_df.columns = excel_df.columns.str.strip().str.upper()

##raw_layer
raw_df = pd.concat([csv_df, excel_df], ignore_index=True)

def standardize_gender(g):
    if pd.isna(g):
        return 'O'
    g = str(g).strip().lower()
    if g in ['male','m']:
        return 'M'
    elif g in ['female','f']:
        return 'F'
    return 'O'

raw_df['GENDER'] = raw_df['GENDER'].apply(standardize_gender)

raw_df['DOB'] = pd.to_datetime(raw_df['DOB'], errors='coerce')

today = pd.Timestamp.today()

raw_df['AGE'] = today.year - raw_df['DOB'].dt.year
raw_df['AGE'] -= (
    (today.month < raw_df['DOB'].dt.month) |
    ((today.month == raw_df['DOB'].dt.month) &
     (today.day < raw_df['DOB'].dt.day))
)

raw_df['DOB'] = raw_df['DOB'].dt.strftime('%d-%m-%Y')

batch_time = pd.Timestamp.utcnow().tz_localize(None)
raw_df['LOAD_TIMESTAMP'] = batch_time

# FINAL LAYER  
joined_df = pd.merge(
    csv_df,
    excel_df,
    on="USER_ID",
    how="inner",
    suffixes=('_CSV', '_EXCEL')
)

# Gender selection
joined_df['GENDER'] = joined_df['GENDER_CSV'].combine_first(joined_df['GENDER_EXCEL'])
joined_df['GENDER'] = joined_df['GENDER'].apply(standardize_gender)

# DOB selection
joined_df['DOB'] = joined_df['DOB_CSV'].combine_first(joined_df['DOB_EXCEL'])
joined_df['DOB'] = pd.to_datetime(joined_df['DOB'], errors='coerce')

# Age calculation
joined_df['AGE'] = today.year - joined_df['DOB'].dt.year
joined_df['AGE'] = joined_df['AGE'] - (
    (today.month < joined_df['DOB'].dt.month) |
    ((today.month == joined_df['DOB'].dt.month) &
     (today.day < joined_df['DOB'].dt.day))
)

final_df = joined_df[joined_df['AGE'] > 18].copy()

# Safe NAME Selection
if 'NAME_CSV' in final_df.columns:
    final_df['NAME'] = final_df['NAME_CSV']
elif 'NAME' not in final_df.columns and 'NAME_EXCEL' in final_df.columns:
    final_df['NAME'] = final_df['NAME_EXCEL']

# Format DOB
final_df['DOB'] = final_df['DOB'].dt.strftime('%d-%m-%Y')

# Audit Column
final_df['LOAD_TIMESTAMP'] = pd.Timestamp.now()

# Keep Only Required Columns
final_df = final_df[
    [
        'USER_ID',
        'NAME',
        'EMAIL',
        'GENDER',
        'DOB',
        'AGE',
        'LOAD_TIMESTAMP'
    ]
]

final_df = final_df.reset_index(drop=True)


# SNOWFLAKE LOAD (TABLES ALREADY EXIST)

conn = snowflake.connector.connect(
    user=os.getenv("SNOWFLAKE_USER"),
    password=os.getenv("SNOWFLAKE_PASSWORD"),
    account=os.getenv("SNOWFLAKE_ACCOUNT"),
    warehouse=os.getenv("SNOWFLAKE_WAREHOUSE"),
    database=os.getenv("SNOWFLAKE_DATABASE"),
    schema=os.getenv("SNOWFLAKE_SCHEMA")
)

cursor = conn.cursor()

cursor.execute(f"USE DATABASE {os.getenv('SNOWFLAKE_DATABASE')}")
cursor.execute(f"USE SCHEMA {os.getenv('SNOWFLAKE_SCHEMA')}")
cursor.execute(f"USE WAREHOUSE {os.getenv('SNOWFLAKE_WAREHOUSE')}")

write_pandas(conn, raw_df, "RAW_USER", use_logical_type=True)
write_pandas(conn, final_df, "FINAL_USER", use_logical_type=True)

print("Snowflake Load Completed")

cursor.close()
conn.close()